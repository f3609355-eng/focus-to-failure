<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Focus to Failure ‚Äî Adaptive focus training that grows with you." />
  <title>Focus to Failure ‚Äî Wave Trainer</title>
  <meta name="theme-color" content="#2563eb" />
  <link rel="manifest" href="manifest.json" />
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js").catch(() => {});
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=DM+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body class="simple stats-hidden">
  <div class="app" id="app">
    <div class="shell">

      <!-- ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê -->
      <header class="header" id="header">
        <div class="header-top">
          <div class="header-meta">
            <span class="badge mode-badge" id="modeLabel">FOCUS</span>
            <span class="badge phase-badge" id="phaseLabel">--</span>
            <span class="badge goal-badge" id="targetsLabel">Goal: --</span>
          </div>
          <div class="header-icons">
            <button class="icon-btn" id="zenToggleBtn" aria-label="Toggle zen mode" title="Hide timer">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
              </svg>
            </button>
            <button class="icon-btn" id="statsToggleBtn" aria-label="Toggle stats" title="Stats">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                <path d="M5 19V10"/><path d="M12 19V5"/><path d="M19 19V13"/>
              </svg>
            </button>
            <button class="icon-btn advanced-only" id="debugToggleBtn" aria-label="Toggle debug" title="Debug">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M4 6h16v12H4z"/><path d="M7 9h10M7 12h10M7 15h7"/>
              </svg>
            </button>
            <button class="icon-btn" id="openAboutBtn" aria-label="About" title="How to use">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
              </svg>
            </button>
            <button class="icon-btn" id="openSettingsBtn" aria-label="Settings" title="Settings">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.06-.94l2.03-1.58a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.6-.22l-2.39.96a7.13 7.13 0 0 0-1.63-.94l-.36-2.54A.5.5 0 0 0 13.9 1h-3.8a.5.5 0 0 0-.49.42l-.36 2.54c-.58.22-1.12.52-1.63.94l-2.39-.96a.5.5 0 0 0-.6.22L2.7 7.48a.5.5 0 0 0 .12.64l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94L2.82 14.52a.5.5 0 0 0-.12.64l1.92 3.32c.13.23.4.32.64.22l2.39-.96c.5.41 1.05.72 1.63.94l.36 2.54c.04.24.25.42.49.42h3.8c.24 0 .45-.18.49-.42l.36-2.54c.58-.22 1.12-.52 1.63-.94l2.39.96c.24.1.51.01.64-.22l1.92-3.32a.5.5 0 0 0-.12-.64l-2.03-1.58ZM12 15.5A3.5 3.5 0 1 1 12 8a3.5 3.5 0 0 1 0 7.5Z"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="header-timer">
          <div class="timer" id="timerLabel">00:00</div>
          <div class="zen-indicator" id="zenIndicator">Focusing‚Ä¶</div>
          <div class="metrics" id="metricsLabel"></div>
        </div>

        <div class="header-divider"></div>

        <div class="header-controls">
          <div class="ctrl-row">
            <button class="btn btn-primary btn-hero" id="heroBtn">Focus</button>
            <button class="btn btn-good" id="doneBtn" disabled>Done</button>
            <button class="btn btn-warn" id="distractedBtn" disabled>Distracted</button>
            <button class="btn btn-reset" id="resetBtn" disabled>Reset</button>
          </div>
          <div class="ctrl-footer">
            <label class="controls-option" id="autoFocusToggle">
              <input type="checkbox" id="autoStartFocusMain" />
              <span>Auto-start next focus</span>
            </label>
          </div>
        </div>

        <div class="header-status" id="statusLabel">Press Focus and concentrate until you can't.</div>
      </header>

      <!-- ‚ïê‚ïê‚ïê STATS PANEL ‚ïê‚ïê‚ïê -->
      <main class="main-content">

        <section class="card stats-card">
          <!-- Stats summary row -->
          <div class="stats-grid">
            <div class="stat"><div class="stat-label">Today</div><div class="stat-value" id="todayCount">--</div></div>
            <div class="stat"><div class="stat-label">Streak</div><div class="stat-value" id="statStreak">--</div></div>
            <div class="stat"><div class="stat-label">Floor</div><div class="stat-value" id="statFloor">--</div></div>
            <div class="stat"><div class="stat-label">Next Goal</div><div class="stat-value" id="todayGoal">--</div></div>
          </div>
          <div class="stats-context" id="statsContext"></div>
          <div class="trophy-row" id="trophyRow" style="display:none"></div>

          <!-- Tab bar -->
          <div class="chart-tabs" id="chartTabs">
            <button class="chart-tab active" data-tab="progress">Progress</button>
            <button class="chart-tab" data-tab="today">Today</button>
            <button class="chart-tab" data-tab="weekly">Weekly</button>
            <button class="chart-tab" data-tab="consistency">Hit Rate</button>
            <button class="chart-tab" data-tab="distribution">Distribution</button>
            <button class="chart-tab" data-tab="history">History</button>
          </div>

          <!-- Single chart canvas -->
          <div class="chart-wrap" id="chartWrap">
            <canvas id="mainChart"></canvas>
          </div>

          <!-- Empty state (shown when chart has no data) -->
          <div class="chart-empty hidden" id="chartEmpty">
            <div class="chart-empty-icon">üìä</div>
            <div class="chart-empty-text">Complete a few sessions to see your data here.</div>
          </div>

          <!-- History table (shown only on history tab) -->
          <div class="table-wrap hidden" id="historyWrap">
            <table id="historyTable">
              <thead>
                <tr>
                  <th>#</th><th>Phase</th><th>Type</th>
                  <th>Focus</th><th>Goal</th><th>Break</th>
                  <th>T_low</th><th>T_high</th><th>Push</th>
                  <th>Crash</th><th>Over</th><th>Stop</th>
                  <th>Pauses</th><th>Bucket</th><th>Timestamp</th>
                </tr>
              </thead>
              <tbody id="historyBody"></tbody>
            </table>
          </div>
        </section>

        <!-- Debug Panel -->
        <div class="debug-panel hidden" id="debugPanel" aria-live="polite">
          <div class="debug-head">Debug Output</div>
          <pre class="debug-pre" id="debugText"></pre>
        </div>
      </main>
      <div class="version-footer" id="versionLabel"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê SETTINGS MODAL ‚ïê‚ïê‚ïê -->
  <div class="overlay hidden" id="modalBackdrop"></div>
  <div class="modal hidden" id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="modal-header">
      <div class="modal-title" id="settingsTitle">Settings</div>
      <button class="btn btn-pill btn-sm" id="closeSettingsBtn">Close</button>
    </div>
    <div class="modal-body" id="settingsBody">

      <!-- General -->
      <div class="s-section">
        <div class="s-title">General</div>
        <label class="s-row" title="Adjusts break lengths, push difficulty, and progression speed as a group">
          <span>Training intensity</span>
          <select id="intensityPreset">
            <option>Easy</option>
            <option selected>Balanced</option>
            <option>Hard</option>
          </select>
        </label>
        <label class="s-row" title="Scales all text and UI elements ‚Äî 1.0√ó is the default size">
          <span>UI scale</span>
          <div class="s-right">
            <input type="range" id="uiScale" min="0.75" max="1.60" step="0.05" />
            <span class="s-val" id="uiScaleVal">1.0√ó</span>
          </div>
        </label>
        <label class="s-row s-check" title="Reveals break multipliers, wave training parameters, and debug overrides">
          <input type="checkbox" id="advancedToggle" />
          <span>Show advanced settings</span>
        </label>
      </div>

      <!-- Breaks -->
      <div class="s-section">
        <div class="s-title">Breaks</div>
        <label class="s-row" title="Your break length is this percentage of your focus time. Higher = longer breaks">
          <span>Break as % of focus</span>
          <div class="s-right">
            <input type="range" id="breakPercent" min="10" max="40" step="1" />
            <span class="s-val" id="breakPercentVal">25%</span>
          </div>
        </label>
        <label class="s-row" title="Breaks will never be shorter than this, even for very short focus blocks">
          <span>Minimum break (sec)</span>
          <input type="number" id="minBreakSec" min="0" max="600" step="5" />
        </label>
        <label class="s-row" title="Breaks are capped at this length no matter how long you focused">
          <span>Maximum break (min)</span>
          <input type="number" id="maxBreakMin" min="1" max="60" step="1" />
        </label>

        <!-- Break multipliers (advanced) -->
        <div class="advanced-only">
          <div class="s-divider"></div>
          <label class="s-row" title="When you crash (end well below your floor), break is multiplied by this. Higher = more recovery time after a bad block">
            <span>Crash break multiplier</span>
            <div class="s-right">
              <input type="range" id="crashMult" min="1.0" max="2.5" step="0.05" />
              <span class="s-val" id="crashMultVal">1.50√ó</span>
            </div>
          </label>
          <label class="s-row" title="When you overshoot (focus much longer than your ceiling), break is multiplied by this to prevent burnout">
            <span>Overshoot break multiplier</span>
            <div class="s-right">
              <input type="range" id="overMult" min="1.0" max="2.0" step="0.05" />
              <span class="s-val" id="overMultVal">1.20√ó</span>
            </div>
          </label>
          <label class="s-row" title="Push blocks are harder stretch goals ‚Äî this gives you a longer break after them">
            <span>Push break multiplier</span>
            <div class="s-right">
              <input type="range" id="pushMult" min="1.0" max="2.0" step="0.05" />
              <span class="s-val" id="pushMultVal">1.25√ó</span>
            </div>
          </label>
        </div>
      </div>

      <!-- Training (advanced) -->
      <div class="s-section advanced-only">
        <div class="s-title">Training Cycle</div>
        <label class="s-row" title="Controls how much wave cycle info is shown in the header badges">
          <span>Wave visibility</span>
          <select id="waveVisibility">
            <option>Hidden</option>
            <option selected>Subtle</option>
            <option>Full</option>
          </select>
        </label>
        <label class="s-row" title="How much your goal decreases for each additional block in a day. 0% = no fatigue adjustment. Higher values give bigger discounts for later blocks.">
          <span>Fatigue rate per block</span>
          <div class="s-right">
            <input type="range" id="fatigueRate" min="0" max="0.10" step="0.01" />
            <span class="s-val" id="fatigueRateVal">6%</span>
          </div>
        </label>
        <div class="s-divider"></div>
        <label class="s-row s-check" title="When enabled, replaces the adaptive goal with a fixed manual goal for testing">
          <input type="checkbox" id="goalOverrideEnabled" />
          <span>Manual goal override</span>
        </label>
        <label class="s-row" title="The fixed goal in minutes when manual override is enabled">
          <span>Override goal (min)</span>
          <input type="number" id="goalOverrideMin" min="1" max="240" step="1" />
        </label>
      </div>

      <!-- Data -->
      <div class="s-section">
        <div class="s-title">Data</div>
<div class="s-label">Backup (recommended)</div>
<div class="s-btn-row">
  <label class="btn btn-sm btn-default file-btn" title="Restore everything (history + settings + training state) from a backup JSON file">Import Backup<input type="file" id="importBackupInput" accept=".json" /></label>
  <button class="btn btn-sm btn-default" id="exportBackupBtn" title="Download a single JSON backup containing history + settings + training state">Export Backup</button>
  <button class="btn btn-sm btn-danger" id="resetAppBtn" title="Clear history, settings, and training state (full reset)">Reset App</button>
</div>

        <div class="s-label">History</div>
        <div class="s-btn-row">
          <label class="btn btn-sm btn-default file-btn" title="Load a previously exported JSONL history file">Import<input type="file" id="importJsonlInput" accept=".jsonl,.txt" /></label>
          <button class="btn btn-sm btn-default" id="exportJsonlBtn" title="Save all focus blocks as a JSONL file">Export JSONL</button>
          <button class="btn btn-sm btn-default" id="exportCsvBtn" title="Save all focus blocks as a CSV spreadsheet">Export CSV</button>
          <button class="btn btn-sm btn-danger" id="clearAllBtn" title="Delete all saved focus blocks permanently">Clear All</button>
        </div>
        <div class="s-label">Settings</div>
        <div class="s-btn-row">
          <label class="btn btn-sm btn-default file-btn" title="Load settings from a previously exported JSON file">Import<input type="file" id="importSettingsInput" accept=".json" /></label>
          <button class="btn btn-sm btn-default" id="exportSettingsBtn" title="Save your current settings to a JSON file for backup">Export</button>
          <button class="btn btn-sm btn-default" id="resetDefaultsBtn" title="Reset all settings to their original default values">Reset Defaults</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê ABOUT MODAL ‚ïê‚ïê‚ïê -->
  <div class="modal hidden" id="aboutModal" role="dialog" aria-modal="true" aria-labelledby="aboutTitle">
    <div class="modal-header">
      <div class="modal-title" id="aboutTitle">How to Use Focus to Failure</div>
      <button class="btn btn-pill btn-sm" id="closeAboutBtn">Close</button>
    </div>
    <div class="modal-body about-body">

      <div class="about-hero">
        <div class="about-hero-icon">üéØ</div>
        <p class="about-hero-text">Focus until you can't. The app learns your rhythm and grows with you.</p>
      </div>

      <div class="about-section">
        <div class="about-heading">The Core Loop</div>
        <div class="about-steps">
          <div class="about-step">
            <span class="about-step-num">1</span>
            <div>
              <strong>Press Focus</strong> and do your work. Don't watch the timer ‚Äî use zen mode (the eye icon) to hide it. Just work until your concentration breaks naturally.
            </div>
          </div>
          <div class="about-step">
            <span class="about-step-num">2</span>
            <div>
              <strong>Press Done</strong> when you feel your focus slipping but you're choosing to stop. Press <strong>Distracted</strong> if you realize you've already lost focus. Be honest ‚Äî the distinction helps the algorithm understand your patterns.
            </div>
          </div>
          <div class="about-step">
            <span class="about-step-num">3</span>
            <div>
              <strong>Take your break.</strong> The app calculates break length based on how long you focused. Step away from the screen. Move. Look at something far away. Then come back for the next block.
            </div>
          </div>
        </div>
      </div>

      <div class="about-section">
        <div class="about-heading">How the Algorithm Works</div>
        <p>The app tracks your <strong>floor</strong> ‚Äî the 35th percentile of your recent sessions. This is what you can reliably do on an average day. Everything is built around raising this number over time.</p>

        <div class="about-concept">
          <span class="about-concept-label">üìà Linear Phase</span>
          Your first sessions. The app is learning your baseline. Goals increase as you prove consistency. Once you plateau, you transition to Wave mode.
        </div>

        <div class="about-concept">
          <span class="about-concept-label">üåä Wave Phase</span>
          Alternating cycles of <strong>Push</strong> blocks (stretch goals above your floor) and <strong>Consolidation</strong> blocks (comfortable goals at your floor). The mix adapts to your momentum ‚Äî when you're hitting goals consistently, you get more pushes. When you're struggling, more consolidation.
        </div>

        <div class="about-concept">
          <span class="about-concept-label">‚ö° Momentum</span>
          Your rolling win rate over the last 5 blocks. <strong>Hot</strong> (80%+) means aggressive cycles. <strong>Steady</strong> (40-80%) means balanced. <strong>Recovery</strong> (below 40%) means easy cycles with gentle pushes. You'll see your momentum in the stats bar.
        </div>

        <div class="about-concept">
          <span class="about-concept-label">üò¥ Fatigue Curve</span>
          Your 4th block of the day is harder than your 1st. The app knows this. Goals automatically decrease for later blocks (6% per block by default, adjustable in settings). A 22-minute block 4 after three 30-minute blocks is a great session ‚Äî the algorithm treats it that way.
        </div>
      </div>

      <div class="about-section">
        <div class="about-heading">What the Stats Mean</div>
        <div class="about-concept">
          <span class="about-concept-label">üè† Floor</span>
          Your reliable baseline ‚Äî what you can do on an okay day. This is the number you're trying to raise. When it goes up, you've genuinely improved.
        </div>
        <div class="about-concept">
          <span class="about-concept-label">üî• Streak</span>
          Consecutive sessions where you hit your goal. Long streaks mean the algorithm has dialed in your level. Broken streaks are fine ‚Äî they're information, not failure.
        </div>
        <div class="about-concept">
          <span class="about-concept-label">üèÜ Milestones</span>
          Earned when your floor crosses key thresholds (15m, 20m, 25m, 30m, etc). These are permanent. They represent real, sustained growth ‚Äî not a single good session.
        </div>
        <div class="about-concept">
          <span class="about-concept-label">üìä Weekly Floor Delta</span>
          Shown in the stats bar. Tells you whether your floor moved up, down, or held steady compared to last week. The most important feedback signal in the app.
        </div>
      </div>

      <div class="about-section">
        <div class="about-heading">Tips for Getting the Most Out of It</div>
        <div class="about-tip"><strong>Be consistent, not heroic.</strong> Three 25-minute blocks every day beats one 90-minute block once a week. The algorithm rewards consistency.</div>
        <div class="about-tip"><strong>Use zen mode.</strong> Watching the timer is counterproductive. Hide it and let the app do the tracking. You'll get a subtle indicator when you hit your goal.</div>
        <div class="about-tip"><strong>Don't chase overshoots.</strong> Going way past your goal feels great but it inflates your stats and can make tomorrow's goals too hard. When you hit your goal, finishing soon after is ideal.</div>
        <div class="about-tip"><strong>Distracted ‚â† failure.</strong> Pressing "Distracted" gives the algorithm honest data. A short distracted block followed by a strong recovery block is better than a long block where you were half-checked-out.</div>
        <div class="about-tip"><strong>Trust the fatigue curve.</strong> If your 4th block feels easy despite the lower goal, that's the system working. You're building endurance without burnout.</div>
        <div class="about-tip"><strong>The floor is everything.</strong> Ignore individual sessions. The floor is the signal. If it's trending up week over week, you're improving. Everything else is noise.</div>
      </div>

      <div class="about-section about-section-last">
        <div class="about-heading">Keyboard Shortcuts</div>
        <div class="about-keys">
          <span class="about-key"><kbd>Space</kbd> Start focus / Pause / Resume</span>
          <span class="about-key"><kbd>Esc</kbd> Close modals</span>
        </div>
      </div>

    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê WIN MODAL ‚ïê‚ïê‚ïê -->
  <div id="winModal" class="win-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="winModalTitle">
    <div class="win-card">
      <canvas id="confettiCanvas" class="confetti-canvas" aria-hidden="true"></canvas>
      <div class="win-emoji" id="stickerEmoji">‚≠ê</div>
      <div class="win-title" id="winModalTitle">Nice. You earned a sticker.</div>
      <div class="win-body" id="winModalText">Goal met. Sticker earned.</div>
      <div class="win-meta">
        <span class="streak-pill" id="stickerStreak">Streak: 1</span>
      </div>
      <div class="win-actions">
        <button id="winModalOk" class="btn btn-claim">Claim It</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê MILESTONE MODAL ‚ïê‚ïê‚ïê -->
  <div id="milestoneModal" class="win-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="milestoneTitle">
    <div class="win-card milestone-card">
      <canvas id="confettiCanvas2" class="confetti-canvas" aria-hidden="true"></canvas>
      <div class="win-emoji milestone-emoji" id="milestoneEmoji">üèÜ</div>
      <div class="win-title" id="milestoneTitle">Floor Milestone!</div>
      <div class="win-body" id="milestoneText">Your floor has reached a new level.</div>
      <div class="win-actions">
        <button id="milestoneOk" class="btn btn-claim" onclick="document.getElementById('milestoneModal').classList.add('hidden')">Continue</button>
      </div>
    </div>
  </div>

  <script src="app.js" type="module"></script>
</body>
</html>
